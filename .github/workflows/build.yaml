name: Build & Test

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    name: 'Build & Test'
    runs-on: ubuntu-latest
    env:
      TZ: 'Pacific/Auckland'

    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: 'Setup JDK'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 'Setup Gradle'
        uses: gradle/actions/setup-gradle@v4.3.0

      - name: 'Setup ENV '
        run: |
          echo "garmin.consumer_key=${{ secrets.GARMIN_CONSUMER_KEY }}" >> local.properties
          echo "garmin.consumer_secret=${{ secrets.GARMIN_CONSUMER_SECRET }}" >> local.properties
          echo "strava.client_id=${{ secrets.STRAVA_CLIENT_ID }}" >> local.properties
          echo "strava.client_secret=${{ secrets.STRAVA_CLIENT_SECRET }}" >> local.properties
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: 'Build'
        id: build
        run: ./gradlew assemble

      - name: 'Tests'
        id: unit_tests
        run: ./gradlew testReleaseUnitTest

#      - name: 'Android tests'
#        id: android_tests
#        run: ./gradlew pixel9ProCheck

      - name: 'Lint'
        id: lint
        run: ./gradlew lint

      - name: 'Generate Summary'
        id: summary
        if: always()
        run: |
          echo "## Build and Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** [ "${{ steps.unit_tests.outcome }}" = "success" ] && ✅ || ❌" >> $GITHUB_STEP_SUMMARY


