name: Build & Test

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    name: 'Build & Test'
    runs-on: ubuntu-latest
    env:
      TZ: 'Pacific/Auckland'

    steps:
      - name: 'Checkout ðŸ“¥'
        uses: actions/checkout@v4

      - name: 'Setup JDK â˜•'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 'Setup Gradle ðŸ˜'
        uses: gradle/actions/setup-gradle@v4

      - name: 'Setup ENV ðŸ› ï¸'
        run: |
          echo "garmin.consumer_key=${{ secrets.GARMIN_CONSUMER_KEY }}" >> local.properties
          echo "garmin.consumer_secret=${{ secrets.GARMIN_CONSUMER_SECRET }}" >> local.properties
          echo "strava.client_id=${{ secrets.STRAVA_CLIENT_ID }}" >> local.properties
          echo "strava.client_secret=${{ secrets.STRAVA_CLIENT_SECRET }}" >> local.properties
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: 'Build ðŸ“¦'
        run: ./gradlew assemble

      - name: 'Tests ðŸ§ª'
        run: ./gradlew testReleaseUnitTest

      - name: 'Android tests ðŸ“±ðŸ§ª'
        run: ./gradlew pixel9ProCheck

      - name: 'Lint ðŸ–ï¸'
        run: ./gradlew lint

      - name: 'Generate Summary ðŸ“'
        if: always()
        runs: |
          # Initialize variables with default values (in case steps fail)
          UNIT_TESTS_STATUS="âŒ"
          ANDROID_TESTS_STATUS="âŒ"
          LINT_STATUS="âŒ"

          # Check for the existence of the steps and their outcomes *after* the steps have run.
          #  This is done using conditional logic within the 'run' step.
          if [ "${{ job.status }}" = "success" ]; then
            if [ "${{ steps.unit_tests.outcome }}" = "success" ]; then
              UNIT_TESTS_STATUS="âœ…"
            fi
            if [ "${{ steps.android_tests.outcome }}" = "success" ]; then
              ANDROID_TESTS_STATUS="âœ…"
            fi
            if [ "${{ steps.lint.outcome }}" = "success" ]; then
              LINT_STATUS="âœ…"
            fi
          fi

          echo "## Build and Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** âœ…" >> $GITHUB_STEP_SUMMARY # Assuming assemble always succeeds
          echo "- **Unit Tests:** ${UNIT_TESTS_STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android Tests:** ${ANDROID_TESTS_STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint:** ${LINT_STATUS}" >> $GITHUB_STEP_SUMMARY
      

      - name: Upload Build Results Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-results
          path: /home/runner/work/_temp/.gradle-actions/build-results/
